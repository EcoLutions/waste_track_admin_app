<div class="h-full flex flex-col gap-4">
  <!-- Compact Header -->
  <div class="bg-white rounded-lg px-4 py-3 border border-gray-200">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2.5">
        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
          <i class="pi pi-map text-green-600"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold text-gray-900">Rutas Activas</h1>
          <p class="text-xs text-gray-500">
            @if (districtName()) {
              {{ districtName() }} · Monitoreo en tiempo real
            }
          </p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="flex items-center gap-2">
        <!-- View Toggle -->
        <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5">
          <button
            (click)="setViewMode('map')"
            [class]="viewMode() === 'map'
              ? 'px-3 py-1.5 text-xs text-white bg-green-600 rounded'
              : 'px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded'"
            class="transition-all duration-200 flex items-center gap-1.5">
            <i class="pi pi-map text-sm"></i>
            <span>Mapa</span>
          </button>
          <button
            (click)="setViewMode('list')"
            [class]="viewMode() === 'list'
              ? 'px-3 py-1.5 text-xs text-white bg-green-600 rounded'
              : 'px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded'"
            class="transition-all duration-200 flex items-center gap-1.5">
            <i class="pi pi-list text-sm"></i>
            <span>Lista</span>
          </button>
          <button
            (click)="setViewMode('split')"
            [class]="viewMode() === 'split'
              ? 'px-3 py-1.5 text-xs text-white bg-green-600 rounded'
              : 'px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-200 rounded'"
            class="transition-all duration-200 flex items-center gap-1.5">
            <i class="pi pi-th-large text-sm"></i>
            <span>Dividido</span>
          </button>
        </div>

        <button
          (click)="refreshRoutes()"
          [disabled]="isLoading()"
          class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5">
          <i class="pi pi-refresh text-sm" [class.animate-spin]="isLoading()"></i>
          <span>Actualizar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-3 shadow-sm animate-slide-down">
      <div class="flex items-start gap-2.5">
        <i class="pi pi-exclamation-circle text-red-600 text-lg mt-0.5"></i>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-red-900">Error al cargar rutas</p>
          <p class="text-sm text-red-700 mt-0.5">{{ error() }}</p>
        </div>
        <button
          (click)="store.setError(null)"
          class="text-red-400 hover:text-red-600 transition-colors">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex-1 bg-white rounded-lg border border-gray-200 flex items-center justify-center">
      <div class="text-center">
        <div class="w-10 h-10 border-3 border-green-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
        <p class="mt-3 text-sm text-gray-600 font-medium">Cargando rutas activas...</p>
      </div>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading()) {
    <div class="flex-1 flex flex-col gap-4 min-h-0">

      <!-- Compact Real-time Statistics -->
      <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
        <!-- Total Routes -->
        <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-gray-300 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0.5">Total</p>
              <p class="text-xl font-bold text-gray-900">{{ formatNumber(totalRoutes()) }}</p>
            </div>
            <div class="w-9 h-9 bg-blue-50 rounded-lg flex items-center justify-center">
              <i class="pi pi-route text-blue-600"></i>
            </div>
          </div>
        </div>

        <!-- In Progress Routes -->
        <div class="bg-white rounded-lg p-3 border border-green-200 hover:border-green-300 transition-colors relative overflow-hidden">
          <div class="absolute top-0 right-0 w-16 h-16 bg-green-500 opacity-10 rounded-full -mr-8 -mt-8"></div>
          <div class="flex items-center justify-between relative z-10">
            <div class="flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0.5">En Progreso</p>
              <p class="text-xl font-bold text-green-600">{{ formatNumber(inProgressRoutes().length) }}</p>
            </div>
            <div class="w-9 h-9 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-play-circle text-green-600 animate-pulse"></i>
            </div>
          </div>
        </div>

        <!-- Total Distance -->
        <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-gray-300 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0.5">Distancia</p>
              <p class="text-xl font-bold text-gray-900">{{ formatNumber(totalDistance()) }}<span class="text-sm text-gray-500 ml-0.5">km</span></p>
            </div>
            <div class="w-9 h-9 bg-purple-50 rounded-lg flex items-center justify-center">
              <i class="pi pi-map text-purple-600"></i>
            </div>
          </div>
        </div>

        <!-- Average Duration -->
        <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-gray-300 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0.5">Duración Est.</p>
              <p class="text-xl font-bold text-gray-900">{{ formatDuration(totalEstimatedDuration()) }}</p>
            </div>
            <div class="w-9 h-9 bg-orange-50 rounded-lg flex items-center justify-center">
              <i class="pi pi-clock text-orange-600"></i>
            </div>
          </div>
        </div>

        <!-- Waypoints -->
        <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-gray-300 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <p class="text-xs text-gray-500 font-medium mb-0.5">Waypoints</p>
              <p class="text-xl font-bold text-gray-900">{{ averageWaypointsPerRoute() }}<span class="text-sm text-gray-500 ml-0.5">prom</span></p>
            </div>
            <div class="w-9 h-9 bg-indigo-50 rounded-lg flex items-center justify-center">
              <i class="pi pi-map-marker text-indigo-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Compact Filters Bar -->
      <div class="bg-white rounded-lg px-4 py-3 border border-gray-200">
        <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
          <!-- Search -->
          <div class="flex-1 min-w-0">
            <div class="relative">
              <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
              <input
                type="text"
                [value]="searchTerm()"
                (input)="onSearchTermChange($any($event.target).value)"
                placeholder="Buscar por ID, vehículo o conductor..."
                class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
            </div>
          </div>

          <!-- Compact Filters -->
          <div class="flex items-center gap-2 flex-shrink-0">
            <!-- Status Dropdown -->
            <select
              [value]="selectedStatus() || 'all'"
              (change)="onStatusFilterChange($any($event.target).value)"
              class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all bg-white">
              <option value="all">Todos los estados</option>
              @for (status of routeStatuses; track status) {
                <option [value]="status">{{ getStatusLabel(status) }}</option>
              }
            </select>

            <!-- Type Dropdown -->
            <select
              [value]="selectedType() || 'all'"
              (change)="onTypeFilterChange($any($event.target).value)"
              class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all bg-white">
              <option value="all">Todos los tipos</option>
              @for (type of routeTypes; track type) {
                <option [value]="type">{{ getTypeLabel(type) }}</option>
              }
            </select>

            <!-- In Progress Filter Toggle -->
            <button
              (click)="toggleInProgressFilter()"
              [class]="showInProgressOnly()
                ? 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100'
                : 'bg-gray-50 text-gray-600 border-gray-300 hover:bg-gray-100'"
              class="px-3 py-2 border rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1.5">
              <i [class]="showInProgressOnly() ? 'pi pi-check-circle' : 'pi pi-circle'"></i>
              <span class="hidden sm:inline">En progreso</span>
            </button>

            <!-- Clear Filters -->
            @if (hasActiveFilters()) {
              <button
                (click)="clearFilters()"
                class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all duration-200 flex items-center gap-1.5">
                <i class="pi pi-filter-slash text-sm"></i>
              </button>
            }
          </div>
        </div>

        <!-- Active Filters Tags -->
        @if (hasActiveFilters()) {
          <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
            <span class="text-xs text-gray-500 font-medium">Filtros:</span>

            @if (searchTerm()) {
              <span class="inline-flex items-center gap-1.5 px-2 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-md">
                "{{ searchTerm() }}"
                <button (click)="onSearchTermChange('')" class="hover:text-blue-900">
                  <i class="pi pi-times text-xs"></i>
                </button>
              </span>
            }

            @if (selectedStatus()) {
              <span class="inline-flex items-center gap-1.5 px-2 py-1 bg-purple-50 text-purple-700 text-xs font-medium rounded-md">
                {{ getStatusLabel(selectedStatus()!) }}
                <button (click)="onStatusFilterChange('all')" class="hover:text-purple-900">
                  <i class="pi pi-times text-xs"></i>
                </button>
              </span>
            }

            @if (selectedType()) {
              <span class="inline-flex items-center gap-1.5 px-2 py-1 bg-orange-50 text-orange-700 text-xs font-medium rounded-md">
                {{ getTypeLabel(selectedType()!) }}
                <button (click)="onTypeFilterChange('all')" class="hover:text-orange-900">
                  <i class="pi pi-times text-xs"></i>
                </button>
              </span>
            }
          </div>
        }
      </div>

      <!-- Dynamic Content Based on View Mode -->
      <div class="flex-1 min-h-0">
        <!-- Map View -->
        @if (viewMode() === 'map') {
          <div class="h-full bg-white rounded-lg border border-gray-200 overflow-hidden relative">
            <!-- Map Container (placeholder) -->
            <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
              <div class="text-center">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg mb-4 mx-auto">
                  <i class="pi pi-map text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Vista de Mapa</h3>
                <p class="text-sm text-gray-600 mb-4">Integración de mapa en desarrollo</p>
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm">
                  <i class="pi pi-map-marker text-green-600"></i>
                  <span class="text-sm font-medium text-gray-700">{{ routes().length }} rutas activas</span>
                </div>
              </div>
            </div>

            <!-- Map Overlay Controls -->
            <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
              <button class="w-10 h-10 bg-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center">
                <i class="pi pi-plus text-gray-700"></i>
              </button>
              <button class="w-10 h-10 bg-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center">
                <i class="pi pi-minus text-gray-700"></i>
              </button>
              <button class="w-10 h-10 bg-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center">
                <i class="pi pi-compass text-gray-700"></i>
              </button>
            </div>

            <!-- Map Legend -->
            <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-md p-3 z-10">
              <p class="text-xs font-semibold text-gray-900 mb-2">Leyenda</p>
              <div class="space-y-1.5">
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                  <span class="text-xs text-gray-600">En Progreso</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                  <span class="text-xs text-gray-600">Asignada</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                  <span class="text-xs text-gray-600">Completada</span>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- List View -->
        @if (viewMode() === 'list') {
          <div class="h-full flex gap-4">
            <!-- Routes List -->
            <div class="flex-1 bg-white rounded-lg border border-gray-200 overflow-hidden flex flex-col">
              <!-- List Header -->
              <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-sm font-bold text-gray-900">Rutas Activas</h2>
                    <p class="text-xs text-gray-500 mt-0.5">
                      {{ formatNumber(routes().length) }} de {{ formatNumber(totalRoutes()) }} rutas
                    </p>
                  </div>
                </div>
              </div>

              <!-- List Content -->
              <div class="flex-1 overflow-auto">
                @if (routes().length > 0) {
                  <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Ruta
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Estado
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Tipo
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Asignación
                      </th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Waypoints
                      </th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Progreso
                      </th>
                      <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wide">
                        Acciones
                      </th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                      @for (route of routes(); track route.id) {
                        <tr
                          (click)="selectRoute(route)"
                          [class.bg-green-50]="selectedRoute()?.id === route.id"
                          class="hover:bg-gray-50 cursor-pointer transition-colors group">

                          <!-- Route Info -->
                          <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                              <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                                <i class="pi pi-route text-gray-600 text-sm"></i>
                              </div>
                              <div>
                                <p class="text-sm font-bold text-gray-900">Ruta #{{ route.id.substring(0, 8) }}</p>
                                <p class="text-xs text-gray-500">{{ formatDate(route.scheduledDate) }}</p>
                              </div>
                            </div>
                          </td>

                          <!-- Status -->
                          <td class="px-4 py-3">
                            <span [class]="getStatusClass(route.status)">
                              {{ getStatusLabel(route.status) }}
                            </span>
                          </td>

                          <!-- Type -->
                          <td class="px-4 py-3">
                            <span [class]="getTypeClass(route.routeType)">
                              <i [class]="getTypeIcon(route.routeType) + ' text-xs'"></i>
                              {{ getTypeLabel(route.routeType) }}
                            </span>
                          </td>

                          <!-- Assignment -->
                          <td class="px-4 py-3">
                            <div class="text-sm">
                              <p class="text-gray-900 font-medium">
                                {{ route.vehicleId ? 'V-' + route.vehicleId.substring(0, 6) : 'Sin vehículo' }}
                              </p>
                              <p class="text-xs text-gray-500">
                                {{ route.driverId ? 'C-' + route.driverId.substring(0, 6) : 'Sin conductor' }}
                              </p>
                            </div>
                          </td>

                          <!-- Waypoints -->
                          <td class="px-4 py-3 text-center">
                            <div class="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-50 rounded">
                              <i class="pi pi-map-marker text-blue-600 text-xs"></i>
                              <span class="text-sm font-semibold text-blue-700">{{ route.waypoints.length }}</span>
                            </div>
                          </td>

                          <!-- Progress -->
                          <td class="px-4 py-3">
                            <div class="flex items-center justify-center gap-2">
                              @if (isInProgress(route)) {
                                <div class="flex-1 max-w-[80px] bg-gray-200 rounded-full h-2">
                                  <div class="bg-green-600 h-2 rounded-full transition-all"
                                       [style.width.%]="getRouteProgress(route)"></div>
                                </div>
                                <span class="text-xs font-medium text-gray-700">{{ getRouteProgress(route) }}%</span>
                              } @else {
                                <span class="text-xs text-gray-400">—</span>
                              }
                            </div>
                          </td>

                          <!-- Actions -->
                          <td class="px-4 py-3 text-right">
                            <button
                              (click)="selectRoute(route); $event.stopPropagation()"
                              class="text-gray-400 hover:text-green-600 transition-colors p-1.5 hover:bg-green-50 rounded">
                              <i class="pi pi-angle-right text-sm"></i>
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                } @else {
                  <div class="flex flex-col items-center justify-center h-full py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                      <i class="pi pi-route text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-900 font-medium text-base mb-1">No se encontraron rutas</p>
                    <p class="text-gray-500 text-sm text-center max-w-sm">
                      @if (hasActiveFilters()) {
                        Intenta ajustar los filtros de búsqueda
                      } @else {
                        No hay rutas activas en este momento
                      }
                    </p>
                    @if (hasActiveFilters()) {
                      <button
                        (click)="clearFilters()"
                        class="mt-4 px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Limpiar filtros
                      </button>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Route Detail Aside -->
            @if (selectedRoute()) {
              <div class="w-80 bg-white rounded-lg border border-gray-200 overflow-hidden flex flex-col animate-slide-in-right">
                <!-- Aside Header -->
                <div class="px-4 py-3 border-b border-gray-200 bg-gradient-to-br from-green-50 to-green-100">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <h3 class="text-base font-bold text-gray-900">Ruta #{{ selectedRoute()!.id.substring(0, 12) }}</h3>
                      <p class="text-xs text-gray-600 mt-0.5">{{ formatDate(selectedRoute()!.scheduledDate) }}</p>
                    </div>
                    <button
                      (click)="closeRouteDetail()"
                      class="text-gray-400 hover:text-gray-600 transition-colors p-1 hover:bg-white/50 rounded">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>

                  <!-- Status Badges -->
                  <div class="flex items-center gap-2">
                    <span [class]="getStatusClass(selectedRoute()!.status)">
                      {{ getStatusLabel(selectedRoute()!.status) }}
                    </span>
                    <span [class]="getTypeClass(selectedRoute()!.routeType)">
                      <i [class]="getTypeIcon(selectedRoute()!.routeType) + ' text-xs'"></i>
                      {{ getTypeLabel(selectedRoute()!.routeType) }}
                    </span>
                  </div>
                </div>

                <!-- Aside Content -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4">

                  <!-- Assignment Info -->
                  <div>
                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Asignación</h4>
                    <div class="space-y-2.5">
                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Vehículo</span>
                        <span class="text-sm font-medium text-gray-900">
                          {{ selectedRoute()!.vehicleId || 'Sin asignar' }}
                        </span>
                      </div>

                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Conductor</span>
                        <span class="text-sm font-medium text-gray-900">
                          {{ selectedRoute()!.driverId || 'Sin asignar' }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Route Details -->
                  <div>
                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Detalles de Ruta</h4>
                    <div class="space-y-2.5">
                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Waypoints</span>
                        <div class="flex items-center gap-1">
                          <i class="pi pi-map-marker text-blue-600 text-xs"></i>
                          <span class="text-sm font-semibold text-blue-700">{{ selectedRoute()!.waypoints.length }}</span>
                        </div>
                      </div>

                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Distancia</span>
                        <span class="text-sm font-semibold text-gray-900">
                          {{ selectedRoute()!.totalDistance ? formatNumber(selectedRoute()!.totalDistance!) + ' km' : 'No calculada' }}
                        </span>
                      </div>

                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Duración Est.</span>
                        <span class="text-sm font-medium text-gray-900">
                          {{ formatDuration(selectedRoute()!.estimatedDuration) }}
                        </span>
                      </div>

                      @if (selectedRoute()!.actualDuration) {
                        <div class="flex items-start justify-between py-2 border-b border-gray-100">
                          <span class="text-sm text-gray-600">Duración Real</span>
                          <span class="text-sm font-semibold text-green-700">
                            {{ formatDuration(selectedRoute()!.actualDuration) }}
                          </span>
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Timeline -->
                  <div>
                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Timeline</h4>
                    <div class="space-y-2.5">
                      <div class="flex items-start justify-between py-2 border-b border-gray-100">
                        <span class="text-sm text-gray-600">Programado</span>
                        <span class="text-sm font-medium text-gray-900">
                          {{ formatDate(selectedRoute()!.scheduledDate) }}
                        </span>
                      </div>

                      @if (selectedRoute()!.startedAt) {
                        <div class="flex items-start justify-between py-2 border-b border-gray-100">
                          <span class="text-sm text-gray-600">Iniciado</span>
                          <span class="text-sm font-medium text-green-700">
                            {{ formatDate(selectedRoute()!.startedAt!) }}
                          </span>
                        </div>
                      }

                      @if (selectedRoute()!.completedAt) {
                        <div class="flex items-start justify-between py-2 border-b border-gray-100">
                          <span class="text-sm text-gray-600">Completado</span>
                          <span class="text-sm font-medium text-blue-700">
                            {{ formatDate(selectedRoute()!.completedAt!) }}
                          </span>
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Waypoints List -->
                  @if (selectedRoute()!.waypoints.length > 0) {
                    <div>
                      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">
                        Waypoints ({{ selectedRoute()!.waypoints.length }})
                      </h4>
                      <div class="space-y-2 max-h-60 overflow-y-auto">
                        @for (waypoint of selectedRoute()!.waypoints; track waypoint.id; let idx = $index) {
                          <div class="flex items-start gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-700 rounded-full text-xs font-bold flex-shrink-0">
                              {{ idx + 1 }}
                            </div>
                            <div class="flex-1 min-w-0">
                              <div class="flex items-center justify-between mb-1">
                                <p class="text-xs font-medium text-gray-900 truncate">
                                  Contenedor #{{ waypoint.containerId.substring(0, 8) }}
                                </p>
                                <span [class]="getWaypointStatusClass(waypoint.status)">
                                  {{ getWaypointStatusLabel(waypoint.status) }}
                                </span>
                              </div>
                              <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span [class]="getPriorityClass(waypoint.priority)">
                                  {{ getPriorityLabel(waypoint.priority) }}
                                </span>
                                @if (waypoint.estimatedArrivalTime) {
                                  <span>·</span>
                                  <span>ETA: {{ formatTime(waypoint.estimatedArrivalTime) }}</span>
                                }
                              </div>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Progress Info -->
                  @if (isInProgress(selectedRoute()!)) {
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                      <div class="flex items-start gap-2">
                        <i class="pi pi-info-circle text-green-600 text-sm mt-0.5"></i>
                        <div class="flex-1">
                          <p class="text-xs font-medium text-green-900 mb-1">Ruta en Progreso</p>
                          <div class="flex items-center gap-2 mb-2">
                            <div class="flex-1 bg-green-200 rounded-full h-2">
                              <div class="bg-green-600 h-2 rounded-full transition-all"
                                   [style.width.%]="getRouteProgress(selectedRoute()!)"></div>
                            </div>
                            <span class="text-xs font-semibold text-green-700">{{ getRouteProgress(selectedRoute()!) }}%</span>
                          </div>
                          <p class="text-xs text-green-700">
                            {{ getCompletedWaypoints(selectedRoute()!) }} de {{ selectedRoute()!.waypoints.length }} waypoints completados
                          </p>
                        </div>
                      </div>
                    </div>
                  }

                </div>

                <!-- Aside Footer -->
                <div class="px-4 py-3 border-t border-gray-200 bg-gray-50">
                  <div class="flex items-center justify-center gap-2 text-xs text-gray-500">
                    <i class="pi pi-eye"></i>
                    <span>Vista de solo lectura</span>
                  </div>
                </div>
              </div>
            }
          </div>
        }

        <!-- Split View (Map + List) -->
        @if (viewMode() === 'split') {
          <div class="h-full grid grid-cols-2 gap-4">
            <!-- Map Side -->
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden relative">
              <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
                <div class="text-center">
                  <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg mb-4 mx-auto">
                    <i class="pi pi-map text-green-600 text-2xl"></i>
                  </div>
                  <h3 class="text-lg font-bold text-gray-900 mb-2">Mapa de Rutas</h3>
                  <p class="text-sm text-gray-600">Vista integrada próximamente</p>
                </div>
              </div>

              <!-- Map Controls -->
              <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
                <button class="w-10 h-10 bg-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center">
                  <i class="pi pi-plus text-gray-700"></i>
                </button>
                <button class="w-10 h-10 bg-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center">
                  <i class="pi pi-minus text-gray-700"></i>
                </button>
              </div>
            </div>

            <!-- List Side -->
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden flex flex-col">
              <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-bold text-gray-900">Rutas Activas</h3>
                <p class="text-xs text-gray-500 mt-0.5">{{ formatNumber(routes().length) }} rutas</p>
              </div>

              <div class="flex-1 overflow-y-auto p-4 space-y-2">
                @for (route of routes(); track route.id) {
                  <div
                    (click)="selectRoute(route)"
                    [class.ring-2]="selectedRoute()?.id === route.id"
                    [class.ring-green-500]="selectedRoute()?.id === route.id"
                    class="p-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-all">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <p class="text-sm font-bold text-gray-900">Ruta #{{ route.id.substring(0, 8) }}</p>
                        <p class="text-xs text-gray-500">{{ formatDate(route.scheduledDate) }}</p>
                      </div>
                      <span [class]="getStatusClass(route.status)">
                        {{ getStatusLabel(route.status) }}
                      </span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-600">
                      <div class="flex items-center gap-1">
                        <i class="pi pi-map-marker text-blue-600"></i>
                        <span>{{ route.waypoints.length }}</span>
                      </div>
                      @if (route.totalDistance) {
                        <span>·</span>
                        <span>{{ formatNumber(route.totalDistance) }} km</span>
                      }
                      @if (isInProgress(route)) {
                        <span>·</span>
                        <span class="text-green-600 font-medium">{{ getRouteProgress(route) }}%</span>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>

    </div>
  }
</div>
